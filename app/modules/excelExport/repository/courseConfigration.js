var sqlType = require('mssql');
const db_library = require('../../_helpers/db_library')
const param = require('../../_models/parameter_input');


const xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40"> <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">  <Created>2015-06-05T18:17:20Z</Created>  <LastSaved>2018-10-16T17:59:04Z</LastSaved>  <Version>16.00</Version> </DocumentProperties> <OfficeDocumentSettings xmlns="urn:schemas-microsoft-com:office:office">  <AllowPNG/>  <RemovePersonalInformation/> </OfficeDocumentSettings> <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">  <WindowHeight>21135</WindowHeight>  <WindowWidth>32767</WindowWidth>  <WindowTopX>0</WindowTopX>  <WindowTopY>465</WindowTopY>  <ProtectStructure>False</ProtectStructure>  <ProtectWindows>False</ProtectWindows> </ExcelWorkbook> <Styles>  <Style ss:ID="Default" ss:Name="Normal">   <Alignment ss:Vertical="Bottom"/>   <Borders/>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>   <Interior/>   <NumberFormat/>   <Protection/>  </Style>  <Style ss:ID="m292667928">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="m292667968">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="12" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="m292668008">   <Alignment ss:Horizontal="Left" ss:Vertical="Center" ss:WrapText="1"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s25">   <Alignment ss:Vertical="Bottom" ss:WrapText="1"/>  </Style>  <Style ss:ID="s26">   <Borders/>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s27">   <Alignment ss:Vertical="Center" ss:WrapText="1"/>   <Borders/>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s29">   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s30">   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s31">   <Alignment ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s32">   <Alignment ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s33">   <Alignment ss:Vertical="Bottom" ss:WrapText="1"/>   <Borders/>  </Style>  <Style ss:ID="s34">   <Borders/>  </Style>  <Style ss:ID="s35">   <Alignment ss:Vertical="Bottom"/>   <Borders/>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s36">   <Alignment ss:Vertical="Bottom"/>   <Borders/>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s37">   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s38">   <Alignment ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s39">   <Alignment ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s40">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s41">   <Alignment ss:Horizontal="Left" ss:Vertical="Bottom" ss:WrapText="1"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s42">   <Alignment ss:Horizontal="Left" ss:Vertical="Bottom" ss:WrapText="1"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s43">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s44">   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style>  <Style ss:ID="s56">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s58">   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"    ss:Bold="1"/>  </Style>  <Style ss:ID="s62">   <Alignment ss:Horizontal="Left" ss:Vertical="Bottom" ss:WrapText="1"/>   <Borders>    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>   </Borders>   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>  </Style> </Styles> <Worksheet ss:Name="Course Configuration">  <Table ss:ExpandedColumnCount="9" ss:ExpandedRowCount="1000" x:FullColumns="1"   x:FullRows="1" ss:DefaultColumnWidth="46.5" ss:DefaultRowHeight="15">   <Column ss:AutoFitWidth="0" ss:Width="65.25"/>   <Column ss:AutoFitWidth="0" ss:Width="45.75"/>   <Column ss:AutoFitWidth="0" ss:Width="110.25"/>   <Column ss:AutoFitWidth="0" ss:Width="159"/>   <Column ss:StyleID="s25" ss:AutoFitWidth="0" ss:Width="255.75"/>   <Column ss:StyleID="s33" ss:AutoFitWidth="0" ss:Width="44.25"/>   <Column ss:StyleID="s34" ss:AutoFitWidth="0" ss:Width="51.75"/>   <Column ss:StyleID="s34" ss:AutoFitWidth="0" ss:Span="1"/>   <Row ss:Height="15.75">    <Cell ss:MergeAcross="4" ss:StyleID="m292667968"><Data ss:Type="String">Course Configuration Details For Book Code</Data></Cell>   </Row>   <Row ss:AutoFitHeight="0">    <Cell ss:StyleID="s30"><Data ss:Type="String">Book Code</Data></Cell>    <Cell ss:StyleID="s37"/>    <Cell ss:MergeAcross="2" ss:StyleID="m292668008"><Data ss:Type="String">;bookcode;</Data></Cell>   </Row>   <Row>    <Cell ss:StyleID="s30"><Data ss:Type="String">Product Title</Data></Cell>    <Cell ss:StyleID="s37"/>    <Cell ss:MergeAcross="2" ss:StyleID="s62"><Data ss:Type="String">;title;</Data></Cell>    <Cell ss:StyleID="s27"/>    <Cell ss:StyleID="s26"/>    <Cell ss:StyleID="s26"/>   </Row>   <Row>    <Cell ss:MergeAcross="4" ss:StyleID="s58"><Data ss:Type="String">Associated Collections</Data></Cell>   </Row>   <Row>    <Cell ss:StyleID="s30"><Data ss:Type="String">S. No.</Data></Cell>    <Cell ss:MergeAcross="1" ss:StyleID="s56"><Data ss:Type="String">Collections</Data></Cell>    <Cell ss:StyleID="s43"/>    <Cell ss:StyleID="s40"/>   </Row>   ;collections;   <Row>    <Cell ss:MergeAcross="4" ss:StyleID="s58"><Data ss:Type="String">Associated Topics, Sub-topics and Videos</Data></Cell>   </Row>   <Row>    <Cell ss:StyleID="s30"><Data ss:Type="String">S. No.</Data></Cell>    <Cell ss:MergeAcross="1" ss:StyleID="m292667928"><Data ss:Type="String">Topics</Data></Cell>    <Cell ss:StyleID="s38"><Data ss:Type="String">Sub-topics</Data></Cell>    <Cell ss:StyleID="s31"><Data ss:Type="String">Video Title</Data></Cell>    <Cell ss:StyleID="s35"/>    <Cell ss:StyleID="s35"/>    <Cell ss:StyleID="s35"/>   </Row>  ;associats;  </Table>  <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">   <PageSetup>    <Header x:Margin="0.3"/>    <Footer x:Margin="0.3"/>    <PageMargins x:Bottom="0.75" x:Left="0.7" x:Right="0.7" x:Top="0.75"/>   </PageSetup>   <Print>    <ValidPrinterInfo/>    <PaperSizeIndex>9</PaperSizeIndex>    <VerticalResolution>0</VerticalResolution>   </Print>   <Selected/>   <Panes>    <Pane>     <Number>3</Number>     <ActiveRow>14</ActiveRow>     <ActiveCol>4</ActiveCol>    </Pane>   </Panes>   <ProtectObjects>False</ProtectObjects>   <ProtectScenarios>False</ProtectScenarios>  </WorksheetOptions> </Worksheet></Workbook>'

const collection = '<Row>    <Cell ss:StyleID="s29"><Data ss:Type="Number">;count;</Data></Cell>    <Cell ss:StyleID="s44"><Data ss:Type="String">;name;</Data></Cell>    <Cell ss:StyleID="s41"/>    <Cell ss:StyleID="s41"/>    <Cell ss:StyleID="s42"/>    <Cell ss:StyleID="s27"/>    <Cell ss:StyleID="s26"/>    <Cell ss:StyleID="s26"/>   </Row>'

const associat = '<Row> <Cell ss:StyleID="s29"><Data ss:Type="Number">;count;</Data></Cell> <Cell ss:StyleID="s39"><Data ss:Type="String">;topic;</Data></Cell> <Cell ss:StyleID="s39"/> <Cell ss:StyleID="s32"><Data ss:Type="String">;subtopic;</Data></Cell> <Cell ss:StyleID="s32"><Data ss:Type="String">;videotitle;</Data></Cell> <Cell ss:StyleID="s36"/> <Cell ss:StyleID="s36"/> <Cell ss:StyleID="s36"/> </Row>'

exports.exportCourseSetting = async (bookId) => {
    return await new Promise((resolve, reject) => {
        let parameters = [];
        let para = new param('bookId', sqlType.BigInt, bookId);
        parameters.push(para);
        db_library
            .execute("[dbo].[GetCourseConfig]", parameters, db_library.query_type.SP).then((value) => {
                var data = xml;
                data = xml.replace(";bookcode;", value.recordsets[0][0].bookCode);
                data = data.replace(";title;", value.recordsets[0][0].productTitle);
                var collections = '';
                var associats = '';
                value.recordsets[1].forEach(element => {
                    var temp = collection;
                    collections = collections + temp.replace(";count;", element.slno).replace(";name;", element.name)
                });
                value.recordsets[2].forEach(element => {
                    var temp = associat
                    associats = associats + temp.replace(";count;", element.slno).replace(";topic;", element.topicName).replace(";subtopic;", element.subTopicName).replace(";videotitle;", element.videoTitle)
                });
                data = data.replace(";collections;", collections);
                data = data.replace(";associats;", associats);
                resolve(data);
            }).catch(err => {
                reject(err)
            });
    });
}